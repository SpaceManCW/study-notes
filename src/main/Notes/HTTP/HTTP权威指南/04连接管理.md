### 连接管理 p80-p112

2022.01.04 首部那块知识需要单独一篇，所以今天写两篇

#### TCP

HTTP连接实际上就是TCP连接和一些使用连接的规则。从TCP一端填入的数据会从另一端以原有的顺序、正确的传送出来。HTTPS的就是在HTTP和TCP之间插入了一个密码加密层（SSL）。HTTP要传送一条报文时，会以流的形式将报文数据的内容通过一条打开的TCP连接按序传输。TCP收到数据流将其砍成小数据块，并将其封装在IP分组中。几条TCP连接可以同时打开，TCP通过端口号保持连接的正常运行。

TCP通过四个值来识别，这四个值唯一定义了一条连接：

- 源IP地址
- 源端口号
- 目的IP地址
- 目的端口号


HTTP事务的性能很大程度上取决于TCP通道的性能。事务处理的时间是很短的，所以HTTP时延就是TCP网络时延造成的。HTTP事务时延有以下原因：

- 初次访问URI要进行DNS解析可能花费数十秒
- TCP建立连接的时间，每条连接最多花费一两秒，但是事务多就会叠加
- 传输请求报文和处理请求报文都需要时间
- 回送响应也需要时间

对于前端来说这部分了解这些足够。。。接下来说一下Connection首部，Connection首部可以承载3种不同类型的标签：

- HTTP首部字段名，列出与此连接有关的首部
- 任意标签值，描述此连接的非标准选项
- 值close，说明操作完后需要关闭这条持久连接

然后需要了解一个概念：TCP慢启动，简单来说就是给一些数据进行传输，TCP不能一次都传输出去，首先发一个分组等待确认。然后可以发两个分组，每个分组都要被确认，然后可以发四个，进而越来越快。这种机制称为TCP慢启动，防止因特网突然过载和拥塞。

#### Keep-Alive

串行持久连接，事务处理结束后仍保持打开状态的连接称为持久连接。客户端首部请求包含Connection：Keep-Alive请求将连接保持打开状态。服务端愿意的话就在响应中包含相同的首部。响应中不包含这个首部客户端就认为服务器不支持Keep-Alive就会在发回响应报文后关闭连接。客户端和服务器可以在任意时刻关闭空闲的Keep-Alive，并可随意限制Keep-Alive 所处理的事务数量，这由Keep-Alive首部控制，比如 Keep-Alive：max=5, timeout=120：

- timeout是响应首部发的，估计了服务器想将持久连接保持的时间
- max 是响应首部发送的，估计了服务器希望为多少事务保持此连接的活跃，并不是承诺值

在HTTP 1.0必须这样使用，Keep-Alive不是默认使用的。在HTTP1.1停止了对Keep-Alive的支持，用一种持久连接改进型代替了它，比Keep-Alive机制更好一些。HTTP1.0默认开启持久连接，想要在事务处理完关闭连接必须向响应报文添加一个Connection：close首部。如果客户端不想发请求了就在最后一条请求首部加上Connection：close

#### 管道与连接关闭

HTTP1.1允许在持久连接上可选的使用**请求通道**，传统持久连接是一个事务处理完再处理下一个，管道就是一个事务还在处理就发送下一个请求处理下一个事务，降低网络环回时间。在管道化连接中客户端可以把大量的请求放入队列中排队，但源服务器可以关闭连接，这样会留下大量未处理的请求需要重新调度。所有HTTP客户端、服务器或代理都可以在任意时刻关闭一条TCP传输连接。通常会在一条报文结束时关闭连接。
