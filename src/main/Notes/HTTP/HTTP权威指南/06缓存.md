### 缓存 p170-p206

当请求到达缓存，本地有已缓存的副本，就从本地设备提取文档。有以下好处:

- 减少冗余数据传输
- 缓解网络瓶颈问题，很少的带宽就可以快速加载页面
- 降低对服务器的要求，服务器可以更快的响应，避免过载
- 降低距离时延，因为从较远的地方加载会很慢

缓存中有副本可以提供服务称为缓存命中，否则就是缓存未命中。服务器的内容可能会修改，要不时进行检测，看看保存的副本是不是最新的副本。这种检测被称为HTTP再验证。HTTP有一些特殊请求不用获取整个对象就可以进行检测。但只有在客户端发起请求时才会进行验证。这块可以单独去了解一下强缓存和协商缓存的机制。由缓存提供服务的请求所占的比例称为缓存命中率，通常用百分数表示。字节命中率是命中的字节数所占的比例，通过这种度量方式可以知道节省了多少流量。客户端可以通过Date的时间来判断是否命中

#### 缓存的处理步骤

- 接收 从网络中读取到达的请求报文
- 解析 对报文进行解析，提取出URL和各种首部
- 查询 查看是否有本地副本，没有就获取一份并保存至本地
- 新鲜度检测 查看已缓存副本是否足够新鲜
- 创建响应 用新首部和已缓存的主体来构建响应报文
- 发送 将响应发回给客户端
- 日志 创建日志描述这个事务

这里的内容主要是讲解协商缓存的过程以及相关首部，不多赘述，单独找一篇文章看比较好，接下来讲一下控制缓存的能力：

服务器可以通过HTTP定义的几种方式来指定在文档过期之前可以将其缓存多长时间按照优先级递减的顺序(以下均添加到响应首部)：

- Cache-Control: no-store 禁止缓存
- Cache-Control: no-cache 可以缓存，但是使用前必须进行验证，也就是协商
- Cache-Control: must-revalidate 过期就必须验证，针对一些会使用过期缓存的情况
- Cache-Control: max-age 设置文档处于新鲜状态的秒数
- Expires 实际过期日期，不推荐使用，因为很多服务器时间不同步

> 试探性过期：响应中没有Cache-Control和Expires时，缓存使用任意算法计算出一个试探性的最大使用期限。如果这个期限超过24小时就应该在响应首部添加一个Heuristic Expiration Warning(试探性过期警告)，但很少有浏览器会提供这种警告。算法计算以最后修改时间为依据，思路就是如果最后修改时间时很久之前，就说明文档比较稳定，就可以缓存很久。如果最近才修改就认为文件可能修改比较频繁，就缓存时间短一点。很多原始服务器不会有Cache-Control和Expires，所以要格外注意。

#### 客户端的新鲜度限制

浏览器都有刷新(Refresh)和重载(Reload)按钮，可以强制对浏览器或代理缓存中的可能过期内容进行刷新。刷新按钮会发布一个附加了Cache-Control请求首部的GET请求，会强制进行验证，客户端用Cache-Control来加强或放松对过期时间的限制。
