### 客户端识别与cookie p272-p

Web服务器可能很多客户端进行对话。服务器通常会记录下来它们在和谁交谈。本章讨论下列用户识别机制：

- 承载用户身份的HTTP首部
- 客户端IP地址跟踪，通过IP地址识别
- 用户登录，用认证的方式识别
- 在URL中嵌入识别信息的技术
- cookie，一种功能强大且高效的持久身份识别技术

#### HTTP首部

大概以下几种首部可用来识别用户：

- From 用户的E-mail地址
- User-Agent 用户的浏览器软件
- Referer 用户进行链接跳转的页面地址
- Authorization 用户名和密码
- Client-IP 客户端IP地址
- X-Forwarded-For 客户端的IP地址
- Cookie 服务器产生的ID标签

From 为防止有些服务器收集E-mail地址发送垃圾邮件，很少有浏览器会发送From首部；User-Agent包括程序名称和版本，通常还包括操作系统的信息，但对于识别特定用户来说意义不大（那你还说这个干嘛？）；Referer说明了用户访问的页面，但不能完全识别用户。

#### 客户端IP地址

使用IP地址来识别用户存在很多缺陷：

- IP地址是机器的地址而不是用户，多个用户公用一台机器就无法识别
- 很多因特网服务提供商会在登录时动态分配IP地址
- 很多用户通过网络地址转换防火墙来浏览网络页面
- 代理和网关会打开新的连接，服务器记录的是代理的IP地址，有些代理可以保留原始IP地址，但不是所有代理都会

#### 用户登录

用Authorization首部说明用户名和密码，对用户名和密码进行加密，浏览器每次请求都带上Authorization首部，只要登录一次就可以在整个会话期间维持用户身份。但浏览不同的站点要记住不同的用户名和密码

#### 胖URL

有些Web站点会为每个用户生成特定版本的URL来追踪用户身份，通常在真正URL开始或结束的地方添加一些状态信息，但也存在很多问题：

- 浏览器显示的胖URL对新用户不友好
- 无法分享，将胖URL发给别人会把个人信息也发过去
- 破坏缓存，每个用户特定URL就意味着不再有公共访问的URL可缓存
- 服务器要重写HTML页面是URL变胖，加大服务器负荷
- 逃逸口，用户跳转到其他页面可能逃离胖URL，导致丢失进展
- 除非用户收藏了胖URL否则退出登录所有信息会丢失

#### Cookie

cookie 是当前识别用户，实现持久会话的最好方式。大多数缓存和浏览器都不允许对cookie进行缓存。cookie可以分为两类，两者唯一的区别就在于过期时间：

- 会话cookie 临时的cookie，记录用户访问站点时的设置和偏好，退出浏览器会话cookie就会删除
- 持久cookie 存在硬盘，浏览器退出、计算机重启时都不会删除，通常用持久cookie维护某个用户会周期性访问的站点的配置文件或登录名

#### Cookie如何工作

用户首次访问Web站点，服务器使用Set-Cookie给用户一个独有的cookie，cookie是键值对的任意列表。cookie可以包含任意信息，通常只包含一个服务器为了识别和跟踪而产生的独特识别码。但也不限于ID号，很多服务器会将信息直接保存在cookie中。用户再次访问就将cookie发给服务器

> 浏览器要负责存储cookie，所以此系统被称为客户端侧状态，这个cookie的规范正式命名为HTTP状态管理机制

不同浏览器以不同的方式存储cookie，网景将cookie存储在一个名为cookies.txt的文本文件里，文件的每行代表一个cookie；IE将cookie存储在高速缓存目录下独立的文本文件中。
